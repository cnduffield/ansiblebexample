ARG REMOTE_SOURCE
ARG REMOTE_SOURCE_DIR
ARG PIP_CERT

FROM ansible-automation-platform-21-ansible-python-toolkit-rhel8:latest AS builder
# =============================================================================
ARG REMOTE_SOURCE_DIR

# NOTE(pabelanger): Copy in data from https://cachito.engineering.redhat.com
# https://source.redhat.com/groups/public/container-build-system/container_build_system_wiki/containers_from_source_multistage_builds_in_osbs#jive_content_id_Cachito_Integration_for_pip
COPY $REMOTE_SOURCE $REMOTE_SOURCE_DIR

COPY . /tmp/src

# NOTE(pabelanger): Combined both requirements files for upper-constraints.txt
RUN cd $REMOTE_SOURCE_DIR/app/ansible-builder \
  && cat build-requirements.txt requirements.txt > /tmp/src/upper-constraints.txt

# NOTE(pabelanger): Disable build isolation for pip3. This means we can use
# existing python RPMs for build dependencies over adding them to cachito.
ENV PIP_OPTS=--no-build-isolation
RUN assemble

FROM ansible-automation-platform-21-ansible-python-base-rhel8:latest
# =============================================================================
ARG PIP_CERT

# NOTE(pabelanger): The pip cert to access cachito
COPY --from=builder $PIP_CERT $PIP_CERT
COPY --from=builder /output/ /output

RUN /output/install-from-bindep \
  && rm -rf /output

# NOTE(pabelanger): Also delete the pip cert
RUN rm -rf $PIP_CERT

COPY --from=builder /usr/local/bin/assemble /usr/local/bin/assemble
COPY --from=builder /usr/local/bin/get-extras-packages /usr/local/bin/get-extras-packages
COPY --from=builder /output/install-from-bindep /output/install-from-bindep

ENV DESCRIPTION="Red Hat Ansible Automation Platform Ansible Builder Execution Environment" \
    container=oci

LABEL com.redhat.component="ansible-builder-container" \
      name="ansible-automation-platform-21/ansible-builder-rhel8" \
      version="1.0.1" \
      summary="${DESCRIPTION}" \
      io.openshift.expose-services="" \
      io.openshift.tags="automation,ansible" \
      io.k8s.display-name="ansible-builder-rhel8" \
      maintainer="Ansible Automation Platform Productization Team" \
      description="${DESCRIPTION}"
